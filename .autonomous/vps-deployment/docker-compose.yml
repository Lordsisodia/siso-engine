# RALF VPS Deployment - Docker Compose
# Multi-agent autonomous system with verification

version: '3.8'

services:
  # Redis for task queue and state management
  redis:
    image: redis:7-alpine
    container_name: ralf-redis
    restart: unless-stopped
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # API Gateway - webhook receiver and agent coordination
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: ralf-api
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - REDIS_URL=redis://redis:6379
      - RALF_PROJECT_DIR=/var/ralf/project
      - RALF_DATA_DIR=/var/ralf/data
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GLM_API_KEY=${GLM_API_KEY}
    volumes:
      - /var/ralf/project:/var/ralf/project:rw
      - /var/ralf/data:/var/ralf/data:rw
      - /var/log/ralf:/var/log/ralf:rw
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Planner Agent - strategic planning and task generation
  planner:
    build:
      context: .
      dockerfile: Dockerfile.agent
      args:
        AGENT_TYPE: planner
    container_name: ralf-planner
    restart: unless-stopped
    environment:
      - RALF_AGENT_TYPE=planner
      - RALF_AGENT_ID=ralf-planner-01
      - RALF_PROJECT_DIR=/var/ralf/project
      - RALF_DATA_DIR=/var/ralf/data
      - RALF_API_URL=http://api:8000
      - REDIS_URL=redis://redis:6379
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GLM_API_KEY=${GLM_API_KEY}
      - RALF_MODEL=${RALF_MODEL:-claude-sonnet-4-5-20251101}
      - RALF_LOOP_INTERVAL=30
    volumes:
      - /var/ralf/project:/var/ralf/project:rw
      - /var/ralf/data:/var/ralf/data:rw
      - /var/log/ralf:/var/log/ralf:rw
      - planner-runs:/var/ralf/runs
    depends_on:
      - api
      - redis
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  # Executor Agent - task execution
  executor:
    build:
      context: .
      dockerfile: Dockerfile.agent
      args:
        AGENT_TYPE: executor
    container_name: ralf-executor
    restart: unless-stopped
    environment:
      - RALF_AGENT_TYPE=executor
      - RALF_AGENT_ID=ralf-executor-01
      - RALF_PROJECT_DIR=/var/ralf/project
      - RALF_DATA_DIR=/var/ralf/data
      - RALF_API_URL=http://api:8000
      - REDIS_URL=redis://redis:6379
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GLM_API_KEY=${GLM_API_KEY}
      - RALF_MODEL=${RALF_MODEL:-claude-sonnet-4-5-20251101}
      - RALF_LOOP_INTERVAL=30
    volumes:
      - /var/ralf/project:/var/ralf/project:rw
      - /var/ralf/data:/var/ralf/data:rw
      - /var/log/ralf:/var/log/ralf:rw
      - executor-runs:/var/ralf/runs
      - /var/run/docker.sock:/var/run/docker.sock  # For container operations
    depends_on:
      - api
      - redis
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G

  # Verifier Agent - post-execution verification
  verifier:
    build:
      context: .
      dockerfile: Dockerfile.agent
      args:
        AGENT_TYPE: verifier
    container_name: ralf-verifier
    restart: unless-stopped
    environment:
      - RALF_AGENT_TYPE=verifier
      - RALF_AGENT_ID=ralf-verifier-01
      - RALF_PROJECT_DIR=/var/ralf/project
      - RALF_DATA_DIR=/var/ralf/data
      - RALF_API_URL=http://api:8000
      - REDIS_URL=redis://redis:6379
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GLM_API_KEY=${GLM_API_KEY}
      - RALF_VERIFY_THRESHOLD_AUTO=${RALF_VERIFY_THRESHOLD_AUTO:-0.85}
      - RALF_VERIFY_THRESHOLD_REVIEW=${RALF_VERIFY_THRESHOLD_REVIEW:-0.60}
      - RALF_NOTIFY_WEBHOOK=${RALF_NOTIFY_WEBHOOK}
      - RALF_AUTO_PUSH=${RALF_AUTO_PUSH:-true}
    volumes:
      - /var/ralf/project:/var/ralf/project:rw
      - /var/ralf/data:/var/ralf/data:rw
      - /var/log/ralf:/var/log/ralf:rw
      - verifier-runs:/var/ralf/runs
    depends_on:
      - api
      - redis
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  # Nginx reverse proxy
  nginx:
    image: nginx:alpine
    container_name: ralf-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - /var/log/nginx:/var/log/nginx
    depends_on:
      - api

  # Prometheus metrics
  prometheus:
    image: prom/prometheus:latest
    container_name: ralf-prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'

  # Grafana dashboards
  grafana:
    image: grafana/grafana:latest
    container_name: ralf-grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./grafana/datasources:/etc/grafana/provisioning/datasources:ro
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}

volumes:
  redis-data:
  planner-runs:
  executor-runs:
  verifier-runs:
  prometheus-data:
  grafana-data:

networks:
  default:
    name: ralf-network
