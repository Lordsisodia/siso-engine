# Context Gathering Optimization Configuration
# BlackBox5 - Operations
#
# Purpose: Reduce "missed file" errors and improve cross-project task execution efficiency
# Based on: project-relationships.md recommendations (TASK-1769892005)
#
# Usage: Reference this configuration during run initialization to optimize context gathering

# =============================================================================
# METADATA
# =============================================================================

metadata:
  version: "1.0.0"
  created_at: "2026-02-01T08:30:00Z"
  created_by: "RALF-Executor"
  source_task: "TASK-1769895000"
  update_frequency: "as-needed"
  last_updated: "2026-02-01T08:30:00Z"

# =============================================================================
# CONTEXT GATHERING HEURISTICS
# =============================================================================

heuristics:
  - id: engine_dependency_detection
    name: "Engine Dependency Detection"
    pattern: "Task involves BMAD commands, skills, or workflows"
    indicators:
      - "BMAD command mentioned (CP, VP, EP, CA, VA, etc.)"
      - "Skill usage mentioned"
      - "Workflow execution mentioned"
      - "2-engine path referenced"
    required_reads:
      - path: "2-engine/.autonomous/routes.yaml"
        reason: "Contains all BMAD command routing"
      - path: "2-engine/.autonomous/skills/"
        reason: "Skill definitions and usage patterns"
    priority: high

  - id: pattern_reference_detection
    name: "Pattern Reference Detection"
    pattern: "Task involves project structure or organization"
    indicators:
      - "STATE.yaml mentioned"
      - "Project structure referenced"
      - "siso-internal mentioned"
      - "Organization patterns discussed"
    required_reads:
      - path: "5-project-memory/siso-internal/STATE.yaml"
        reason: "Gold standard for project organization"
      - path: "operations/project-map.yaml"
        reason: "Cross-project relationship map"
    priority: high

  - id: cross_project_documentation
    name: "Cross-Project Documentation"
    pattern: "Creating documentation that applies to multiple projects"
    indicators:
      - "Documentation creation mentioned"
      - "Multiple project paths referenced"
      - ".docs/ folder mentioned"
      - "Pattern replication mentioned"
    required_reads:
      - path: "operations/project-map.yaml"
        reason: "Identify affected projects"
      - path: ".autonomous/routes.yaml"
        reason: "Project paths and routing"
    priority: medium

  - id: shared_config_detection
    name: "Shared Configuration Detection"
    pattern: "Task involves CLAUDE.md or other shared files"
    indicators:
      - "CLAUDE.md mentioned"
      - "~/.claude/ path referenced"
      - "Global configuration mentioned"
      - "Shared file referenced"
    required_reads:
      - path: "~/.claude/CLAUDE.md"
        reason: "Core agent instructions"
      - path: "operations/project-map.yaml"
        section: "shared_files"
        reason: "Identify all affected projects"
    priority: high

  - id: multi_project_task
    name: "Multi-Project Task Detection"
    pattern: "Task explicitly spans multiple projects"
    indicators:
      - "Multiple project names in task"
      - "Cross-project mentioned"
      - "2-engine and blackbox5 in same task"
      - "siso-internal and blackbox5 in same task"
    required_reads:
      - path: "operations/project-map.yaml"
        reason: "Full dependency map"
      - path: ".autonomous/routes.yaml"
        reason: "All project paths"
      - path: "2-engine/.autonomous/routes.yaml"
        reason: "Engine routing"
    priority: critical

# =============================================================================
# AUTOMATIC READS - Files to read based on task type
# =============================================================================

automatic_reads:
  all_tasks:
    - path: ".autonomous/routes.yaml"
      reason: "Project routing and paths"
      condition: "always"
    - path: "STATE.yaml"
      reason: "Project state and structure"
      condition: "if_exists"

  cross_project_tasks:
    - path: "operations/project-map.yaml"
      reason: "Cross-project dependencies"
      condition: "if_multi_project_detected"
    - path: "2-engine/.autonomous/routes.yaml"
      reason: "Engine routing and BMAD commands"
      condition: "if_engine_involved"

  documentation_tasks:
    - path: ".docs/"
      reason: "Existing documentation patterns"
      condition: "if_creating_docs"

  implementation_tasks:
    - path: "operations/validation-checklist.yaml"
      reason: "Pre-execution validation"
      condition: "always"

# =============================================================================
# CACHED FILES - Frequently accessed files that should be cached
# =============================================================================

cached_files:
  - path: "~/.claude/CLAUDE.md"
    cache_duration: "1 hour"
    reason: "Frequently referenced, rarely changes"
    priority: high

  - path: "2-engine/.autonomous/routes.yaml"
    cache_duration: "30 minutes"
    reason: "BMAD command reference"
    priority: high

  - path: ".autonomous/routes.yaml"
    cache_duration: "30 minutes"
    reason: "Project routing"
    priority: high

  - path: "operations/project-map.yaml"
    cache_duration: "1 hour"
    reason: "Cross-project reference"
    priority: medium

  - path: "STATE.yaml"
    cache_duration: "15 minutes"
    reason: "Project state changes frequently"
    priority: medium

# =============================================================================
# PATH VALIDATION - Validate paths before file operations
# =============================================================================

path_validation:
  enabled: true
  fail_action: "warn_and_continue"
  validation_rules:
    - rule: "absolute_paths_only"
      description: "Use absolute paths, never relative"
      enforcement: strict

    - rule: "verify_before_read"
      description: "Verify file exists before attempting read"
      enforcement: strict

    - rule: "check_project_map"
      description: "For cross-project paths, check project-map.yaml first"
      enforcement: recommended

    - rule: "routes_yaml_reference"
      description: "Use routes.yaml for path resolution"
      enforcement: recommended

  cross_project_paths:
    - pattern: "../../2-engine/"
      validation: "check_engine_routes"
    - pattern: "../../5-project-memory/"
      validation: "check_project_map"
    - pattern: "~/.claude/"
      validation: "check_exists"

# =============================================================================
# CROSS-PROJECT TASK DETECTION
# =============================================================================

cross_project_detection:
  enabled: true
  detection_methods:
    - method: "path_analysis"
      description: "Scan task for project path references"
      patterns:
        - "2-engine"
        - "siso-internal"
        - "team-entrepreneurship-memory"
        - "blackbox5"
        - "5-project-memory"
      threshold: 2

    - method: "keyword_analysis"
      description: "Scan for cross-project keywords"
      keywords:
        - "cross-project"
        - "multi-project"
        - "shared"
        - "engine"
        - "siso-internal"
        - "BMAD"
        - "skill"
        - "workflow"
      threshold: 1

    - method: "dependency_check"
      description: "Check if task references dependencies from project-map"
      source: "operations/project-map.yaml"

  auto_actions:
    - trigger: "cross_project_detected"
      action: "read_project_map"
      description: "Automatically read project-map.yaml"

    - trigger: "engine_dependency_detected"
      action: "read_engine_routes"
      description: "Automatically read 2-engine routes"

    - trigger: "multi_project_detected"
      action: "read_all_routes"
      description: "Read both project and engine routes"

# =============================================================================
# INTEGRATION GUIDE
# =============================================================================

integration:
  for_executor:
    initialization_steps:
      - step: 1
        action: "Read .autonomous/routes.yaml"
        reason: "Get project paths"
      - step: 2
        action: "Check task for cross-project indicators"
        reason: "Determine if project-map.yaml needed"
      - step: 3
        action: "Apply heuristics from this config"
        reason: "Optimize context gathering"
      - step: 4
        action: "Validate paths before reads"
        reason: "Prevent missed file errors"

    run_initialization:
      description: "Steps to run at start of each execution"
      steps:
        - "Read this configuration file"
        - "Analyze task file for indicators"
        - "Execute automatic_reads based on task type"
        - "Apply path validation rules"
        - "Cache frequently accessed files"

  for_planner:
    planning_steps:
      - step: 1
        action: "Check project-map.yaml for dependencies"
        reason: "Identify affected projects"
      - step: 2
        action: "Reference context_gathering.recommendations"
        reason: "Follow documented heuristics"
      - step: 3
        action: "Note cross-project indicators in task"
        reason: "Help executor optimize"

# =============================================================================
# EFFECTIVENESS METRICS
# =============================================================================

metrics:
  tracking:
    - metric: "missed_file_errors"
      description: "Count of file not found errors per run"
      target: "< 1 per run"
      measurement: "grep -i 'no such file\|not found' runs/executor/*/RESULTS.md"

    - metric: "context_gathering_time"
      description: "Time spent gathering context before execution"
      target: "< 2 minutes"
      measurement: "timestamp difference in THOUGHTS.md"

    - metric: "cross_project_task_detection_rate"
      description: "Percentage of cross-project tasks correctly identified"
      target: "> 90%"
      measurement: "manual review of task classifications"

  review_schedule:
    frequency: "monthly"
    action: "Review metrics and update heuristics"
    owner: "RALF-Executor"

# =============================================================================
# CHANGE LOG
# =============================================================================

changelog:
  - version: "1.0.0"
    date: "2026-02-01"
    changes:
      - "Initial context gathering optimization configuration"
      - "Defined 5 heuristics for cross-project detection"
      - "Specified automatic reads by task type"
      - "Created path validation rules"
      - "Defined effectiveness metrics"

# =============================================================================
# USAGE EXAMPLES
# =============================================================================

examples:
  - scenario: "Task involves BMAD skills"
    task_title: "Implement new skill for workflow X"
    actions:
      - "Read 2-engine/.autonomous/routes.yaml (BMAD commands)"
      - "Read 2-engine/.autonomous/skills/ (existing patterns)"
      - "Check project-map.yaml for skill dependencies"

  - scenario: "Task references siso-internal patterns"
    task_title: "Replicate STATE.yaml structure from siso-internal"
    actions:
      - "Read operations/project-map.yaml (pattern reference)"
      - "Read 5-project-memory/siso-internal/STATE.yaml (source)"
      - "Read STATE.yaml (current state)"

  - scenario: "Task modifies CLAUDE.md"
    task_title: "Update decision framework in CLAUDE.md"
    actions:
      - "Read ~/.claude/CLAUDE.md (target)"
      - "Read operations/project-map.yaml (shared_files section)"
      - "Check all projects affected by change"

# =============================================================================
# RELATED FILES
# =============================================================================

related_files:
  - path: "operations/project-map.yaml"
    relationship: "source_of_cross_project_data"
  - path: "operations/validation-checklist.yaml"
    relationship: "complementary_validation"
  - path: ".autonomous/routes.yaml"
    relationship: "project_routing"
  - path: "operations/.docs/context-gathering-guide.md"
    relationship: "documentation"
